# Core of the mod, will deal with launching the events instead of relying on MTTH

namespace = scfe_game_start

event = {
	id = scfe_game_start.1
	hide_window = yes
	is_triggered_only = yes
	fire_only_once = yes

	trigger = { exists = event_target:global_event_country }

	immediate = {
		every_playable_country = {
			limit = { is_ai = no }
			set_policy = { policy = scfe_precursor_policy option = scfe_precursor_policy_concurrent }
			set_policy = { policy = scfe_archaeology_cleanup option = scfe_archaeology_cleanup_inactive }
		}
		if = {
			limit = {
				# Check if precursor menu is not active
				has_PreSelect_active = no
			}
			event_target:global_event_country = {
				country_event = { id = scfe_game_start.2 days = 10 }
			}
		}
	}
	after = {
		event_target:global_event_country = {
			country_event = { id = scfe_game_start.4 days = 10 }
		}
	}
}

country_event = {
	id = scfe_game_start.2
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		random_playable_country = {
			limit = {
				is_ai = no
				is_valid_origin_for_znkar = yes
			}
			if = {
				limit = { is_multiplayer = yes }
				set_country_flag = scfe_znkar_possible
			}
			else = {
				random_list = {
					50 = { }
					50 = { set_country_flag = scfe_znkar_possible }
				}
			}
		}
		random_playable_country = {
			limit = {
				is_ai = no
				NOT = { has_country_flag = scfe_znkar_possible}
			}
			if = {
				limit = { is_multiplayer = no }
				random_list = {
					50 = { }
					50 = { set_country_flag = scfe_alshigan_possible }
				}
			}
		}
		random_playable_country = {
			limit = {
				is_ai = no
				is_unfriendly = no
			}
			set_country_flag = scfe_galwand_possible
		}
		# Precursor Story Pack
		while = {
			random_playable_country = {
				limit = {
					is_ai = no
					NOT = { has_origin = origin_incohesive }
					NOR = {
						has_country_flag = scfe_precursor_set_sless
						has_country_flag = scfe_precursor_set_coprean
						has_country_flag = scfe_precursor_set_astanine
						has_country_flag = scfe_alshigan_possible
						has_country_flag = scfe_znkar_possible
					}
				}
				random_list = {
					1 = {
						modifier = {
							factor = 0
							any_country = {
								is_ai = no
								has_country_flag = scfe_precursor_set_sless
							}
						}
						set_country_flag = scfe_precursor_set_sless
					}
					1 = {
						modifier = {
							factor = 0
							any_country = {
								is_ai = no
								has_country_flag = scfe_precursor_set_coprean
							}
						}
						set_country_flag = scfe_precursor_set_coprean
					}
					1 = {
						modifier = {
							factor = 0
							any_country = {
								is_ai = no
								has_country_flag = scfe_precursor_set_astanine
							}
						}
						set_country_flag = scfe_precursor_set_astanine
					}
				}
			}
			count = 3
		}
	}
}

event = {
	id = scfe_game_start.3
	hide_window = yes
	is_triggered_only = yes
	fire_only_once = yes

	immediate = {
		event_target:global_event_country = {
			country_event = { id = scfe_engine.7 days = 7200 random = 720 }
		}
	}
}

country_event = {
	id = scfe_game_start.4
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		while = {
			random_system = {
				limit = {
					NOT = { exists = owner }
					scfe_is_valid_system = yes
					any_system_planet = {
						scfe_is_barren = yes
						NOT = { has_modifier = terraforming_candidate }
						has_anomaly = no
						is_moon = no
					}
					NOT = {
						any_neighbor_system = {
							OR = {
								exists = owner
								scfe_is_valid_system = no
							}
						}
					}
				}
				random_system_planet = {
					limit = {
						scfe_is_barren = yes
						NOT = { has_modifier = terraforming_candidate }
						has_anomaly = no
						is_moon = no
					}
					change_pc = pc_nuked
					reset_planet = yes
					clear_deposits = yes
				}
			}
			count = 3
		}
	}
}

namespace = scfe_engine

# Galactic Wanderers
country_event = {
	id = scfe_engine.1
	hide_window = yes
	is_triggered_only = yes
	fire_only_once = yes
	trigger = {
		has_country_flag = scfe_galwand_possible
		AND = {
			has_comms_with_alien_empire = yes
			years_passed > 50
		}
		any_planet_within_border = {
			scfe_is_valid_moon = yes
		}
	}
	immediate = {
		remove_country_flag = scfe_galwand_possible
		country_event = { id = scfe_galactic_wanderers.1 days = 30 random = 30 }
	}
}

# Z'nkar
country_event = {
	id = scfe_engine.2
	hide_window = yes
	is_triggered_only = yes
	fire_only_once = yes
	trigger = {
		has_country_flag = scfe_znkar_possible
		years_passed > 30
		has_met_primitives = yes
		scfe_can_find_precursor = yes
		AND = {
			exists = home_planet
			home_planet = {
				is_artificial = no
				# Still owning your homeworld
				owner = {
					is_same_empire = root
				}
				# Homeworld not currently occupied
				controller = {
					is_same_empire = root
				}
			}
		}
	}
	immediate = {
		remove_country_flag = scfe_znkar_possible
		country_event = { id = scfe_znkar.1 days = 100 random = 200 }
	}
}

# Alshigans
country_event = {
	id = scfe_engine.3
	hide_window = yes
	is_triggered_only = yes
	fire_only_once = yes
	trigger = {
		years_passed > 25
		has_country_flag = scfe_alshigan_possible
		scfe_can_find_precursor = yes
		is_multiplayer = no
	}

	immediate = {
		remove_country_flag = scfe_alshigan_possible
		set_country_flag = scfe_alshigans_possible
	}
}

# Shaded Empire
country_event = {
	id = scfe_engine.4
	hide_window = yes
	is_triggered_only = yes
	fire_only_once = yes

	immediate = {
		random_playable_country = {
			limit = { is_ai = no }
			set_country_flag = scfe_shaded_empire_possible
		}
	}
	after = {
		if = {
			limit = {
				any_country = {
					has_country_flag = scfe_shaded_empire_possible
				}
			}
			random_country = {
				limit = { has_country_flag = scfe_shaded_empire_possible }
				country_event = { id = scfe_engine.5 }
			}
		}
	}
}
country_event = {
	id = scfe_engine.5
	hide_window = yes
	is_triggered_only = yes
	fire_only_once = yes

	immediate = {
		random_system_within_border = {
			limit = {
				NOT = { has_star_flag = empire_home_system }
				any_system_planet = {
					NOT = { exists = owner }
					scfe_is_general_planet = yes
				}
			}
			save_global_event_target_as = shaded_crashed_ship_system
			random_system_planet = {
				limit = {
					NOT = { exists = owner }
					scfe_is_general_planet = yes
				}
				save_global_event_target_as = shaded_crashed_ship_location
				enable_special_project = {
					name = SCFE_SHADED_PROJECT_INIT
					location = event_target:shaded_crashed_ship_location
					owner = root
				}
			}
		}
	}
	after = {
		country_event = { id = scfe_shaded.100 }
	}
}

# Roots initialization
planet_event = {
	id = scfe_engine.6
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		years_passed > 50
		NOT = { has_global_flag = scfe_roots_started }
		exists = owner
		owner = {
			is_ai = no
			is_homicidal = no
			NOT = { has_country_flag = scfe_rooted }
			count_owned_planet = {
				limit = {
					is_colony = yes
					is_capital = no
				}
				count > 3
			}
			any_owned_planet = {
				scfe_is_continental = yes
				planet_size >= 15
				is_terraforming = no
				NOR = {
					has_planet_flag = colony_event
					has_planet_flag = megastructure
					has_planet_flag = has_megastructure
					has_modifier = lush_planet
					has_modifier = ultra_rich
					has_modifier = mineral_rich
				}
			}
		}
	}

	immediate = {
		set_planet_flag = scfe_roots
		set_planet_flag = colony_event
		set_planet_flag = cant_terraform_planet
		set_global_flag = scfe_roots_started
		save_global_event_target_as = scfe_roots_planet
		owner = {
			save_global_event_target_as = scfe_roots_owner
			set_country_flag = scfe_rooted
			country_event = { id = scfe_roots.2 }
		}
	}
}

# Celestial Disturbance
country_event = {
	id = scfe_engine.7
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		random_system = {
			limit = {
				is_rim_system = yes
				is_fe_cluster = no
				scfe_is_valid_star_system = yes
			}
			set_spawn_system_batch = begin
			spawn_system = {
				min_distance = 30
				max_distance = 60
				direction = rimwards
				initializer = "scfe_celestial_disturbance_system"
			}
			set_spawn_system_batch = end
		}
		every_playable_country = {
			limit = { is_ai = no }
			country_event = { id = scfe_celestial_init.1 }
		}
	}
}
# Celestial Disturbance
event = {
	id = scfe_engine.9
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		exists = event_target:scfe_celestial_disturbance_system
	}

	immediate = {
		event_target:scfe_celestial_disturbance_system = {
			remove_star_flag = scfe_ai_avoid_system
		}
	}
}
# AI avoidance flag cleanup
event = {
	id = scfe_engine.10
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		solar_system = {
			has_star_flag = scfe_ai_avoid_system
		}
	}

	immediate = {
		solar_system = {
			remove_star_flag = scfe_ai_avoid_system
		}
	}
}

# The Plague
country_event = {
	id = scfe_engine.11
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		NOR = {
			has_global_flag = scfe_plague_start
			has_country_flag = scfe_sick_pop_check
		}
		is_ai = no
		is_machine_empire = no
		is_synthetic_empire = no
		count_controlled_planet = {
			limit = {
				is_colony = yes
				is_capital = no
				colony_age > 12
				num_pops > 10
			}
			count > 4
		}
		count_controlled_planet = {
			limit = {
				is_colony = yes
				is_capital = no
				colony_age >= 60
				num_pops > 10
				NOT = { has_planet_flag = colony_event }
			}
			count >= 1
		}
	}

	immediate = {
		set_country_flag = scfe_sick_pop_check
		random_list = {
			30 = { country_event = { id = scfe_plague.1 days = 200 random = 100 } }
			70 = { }
		}
	}
}
