# Core of the mod, will deal with launching the events instead of relying on MTTH

namespace = scfe_game_start

event = {
	id = scfe_game_start.1
	hide_window = yes
	is_triggered_only = yes
	fire_only_once = yes

	trigger = { exists = event_target:global_event_country }

	immediate = {
		if = {
			limit = {
				# Check if precursor menu is not active
				has_PreSelect_active = no
			}
			event_target:global_event_country = {
				country_event = { id = scfe_game_start.2 days = 10 }
			}
		}
	}
	after = {
		event_target:global_event_country = {
			country_event = { id = scfe_game_start.4 days = 10 }
		}
	}
}

country_event = {
	id = scfe_game_start.2
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		random_playable_country = {
			limit = {
				is_ai = no
				is_valid_origin_for_znkar = yes
			}
			if = {
				limit = { is_multiplayer = yes }
				set_country_flag = scfe_znkar_possible
			}
			else = {
				random_list = {
					50 = { }
					50 = { set_country_flag = scfe_znkar_possible }
				}
			}
		}
		random_playable_country = {
			limit = {
				is_ai = no
				NOT = { has_country_flag = scfe_znkar_possible}
			}
			if = {
				limit = { is_multiplayer = yes }
				set_country_flag = scfe_alshigan_possible
			}
			else = {
				random_list = {
					50 = { }
					50 = { set_country_flag = scfe_alshigan_possible }
				}
			}
		}
		random_playable_country = {
			limit = {
				is_ai = no
				is_unfriendly = no
			}
			set_country_flag = scfe_galwand_possible
		}
		# Precursor Story Pack
		while = {
			random_playable_country = {
				limit = {
					is_ai = no
					NOT = { has_origin = origin_incohesive }
					NOR = {
						has_country_flag = scfe_precursor_set_sless
						has_country_flag = scfe_precursor_set_coprean
						has_country_flag = scfe_precursor_set_astanine
						has_country_flag = scfe_alshigan_possible
						has_country_flag = scfe_znkar_possible
					}
				}
				random_list = {
					1 = {
						modifier = {
							factor = 0
							any_country = {
								is_ai = no
								has_country_flag = scfe_precursor_set_sless
							}
						}
						set_country_flag = scfe_precursor_set_sless
					}
					1 = {
						modifier = {
							factor = 0
							any_country = {
								is_ai = no
								has_country_flag = scfe_precursor_set_coprean
							}
						}
						set_country_flag = scfe_precursor_set_coprean
					}
					1 = {
						modifier = {
							factor = 0
							any_country = {
								is_ai = no
								has_country_flag = scfe_precursor_set_astanine
							}
						}
						set_country_flag = scfe_precursor_set_astanine
					}
				}
			}
			count = 3
		}
	}
}

country_event = {
	id = scfe_game_start.4
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		while = {
			random_system = {
				limit = {
					NOT = { exists = owner }
					scfe_is_valid_system = yes
					any_system_planet = {
						scfe_is_barren = yes
						NOT = { has_modifier = terraforming_candidate }
						has_anomaly = no
						is_moon = no
					}
					NOT = {
						any_neighbor_system = {
							OR = {
								exists = owner
								scfe_is_valid_system = no
							}
						}
					}
				}
				random_system_planet = {
					limit = {
						scfe_is_barren = yes
						NOT = { has_modifier = terraforming_candidate }
						has_anomaly = no
						is_moon = no
					}
					change_pc = pc_nuked
					reset_planet = yes
					clear_deposits = yes
				}
			}
			count = 3
		}
	}
}

namespace = scfe_engine

# Galactic Wanderers
country_event = {
	id = scfe_engine.1
	hide_window = yes
	is_triggered_only = yes
	fire_only_once = yes
	trigger = {
		has_country_flag = scfe_galwand_possible
		AND = {
			has_comms_with_alien_empire = yes
			years_passed > 50
		}
		any_planet_within_border = {
			scfe_is_valid_moon = yes
		}
	}
	immediate = {
		remove_country_flag = scfe_galwand_possible
		country_event = { id = scfe_galactic_wanderers.1 days = 30 random = 30 }
	}
}

# Z'nkar
country_event = {
	id = scfe_engine.2
	hide_window = yes
	is_triggered_only = yes
	fire_only_once = yes
	trigger = {
		has_country_flag = scfe_znkar_possible
		years_passed > 30
		has_met_primitives = yes
		AND = {
			exists = home_planet
			home_planet = {
				is_artificial = no
				# Still owning your homeworld
				owner = {
					is_same_empire = root
				}
				# Homeworld not currently occupied
				controller = {
					is_same_empire = root
				}
			}
		}
	}
	immediate = {
		remove_country_flag = scfe_znkar_possible
		country_event = { id = scfe_znkar.1 days = 100 random = 200 }
	}
}

# Alshigans
country_event = {
	id = scfe_engine.3
	hide_window = yes
	is_triggered_only = yes
	fire_only_once = yes
	trigger = {
		years_passed > 25
		has_country_flag = scfe_alshigan_possible
	}

	immediate = {
		remove_country_flag = scfe_alshigan_possible
		set_country_flag = scfe_alshigans_possible
	}
}

# Shaded Empire
country_event = {
	id = scfe_engine.4
	hide_window = yes
	is_triggered_only = yes
	fire_only_once = yes

	immediate = {
		random_playable_country = {
			limit = { is_ai = no }
			set_country_flag = scfe_shaded_empire_possible
		}
	}
	after = {
		if = {
			limit = {
				any_country = {
					has_country_flag = scfe_shaded_empire_possible
				}
			}
			random_country = {
				limit = { has_country_flag = scfe_shaded_empire_possible }
				country_event = { id = scfe_engine.5 }
			}
		}
	}
}

country_event = {
	id = scfe_engine.5
	hide_window = yes
	is_triggered_only = yes
	fire_only_once = yes

	immediate = {
		random_system_within_border = {
			limit = {
				NOT = { has_star_flag = empire_home_system }
				any_system_planet = {
					NOT = { exists = owner }
					scfe_is_general_planet = yes
				}
			}
			save_global_event_target_as = shaded_crashed_ship_system
			random_system_planet = {
				limit = {
					NOT = { exists = owner }
					scfe_is_general_planet = yes
				}
				save_global_event_target_as = shaded_crashed_ship_location
				enable_special_project = {
					name = SCFE_SHADED_PROJECT_INIT
					location = event_target:shaded_crashed_ship_location
					owner = root
				}
			}
		}
	}
	after = {
		country_event = { id = scfe_shaded.100 }
	}
}

# Roots initialization
planet_event = {
	id = scfe_engine.6
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		if = {
			limit = {
				NOT = { has_global_flag = scfe_roots_started }
				has_modifier = weak_magnetic_field
				scfe_is_continental = yes
				exists = owner
				owner = {
					is_ai = no
					NOT = { has_country_flag = scfe_rooted }
				}
			}
		}
		set_planet_flag = scfe_roots
		set_planet_flag = cant_terraform_planet
		set_global_flag = scfe_roots_started
		save_global_event_target_as = scfe_roots_planet
		owner = {
			save_global_event_target_as = scfe_roots_owner
			set_country_flag = scfe_rooted
			country_event = { id = scfe_roots.2 }
		}
	}
}
